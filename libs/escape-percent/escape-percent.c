#include <stdio.h>
#include "public/libesq.h"

static const char epip_translate_table[] = {

-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, -1, -1, -1, -1, -1, -1,
-1, 10, 11, 12, 13, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1,
-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
-1, 10, 11, 12, 13, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1,
-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,

-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,

};

/* return -1 for error */
int
escape_percent_in_place(char * buf, int l)	{
	unsigned char code;
	unsigned char t;
	char c;
	int i;
	int w;
	int k;

	w = 0;

	for (i = 0; i < l;)	{
		c = buf[i];
		if ('%' == c)	{
			if (l - i < 3)	{
				return -1;
			}

			t = buf[i + 1];
			k = epip_translate_table[t];
			if (-1 == k)	{
				return -1;
			}
			code = k << 4;

			t = buf[i + 2];
			k = epip_translate_table[t];
			if (-1 == k)	{
				return -1;
			}
			code = code + k;

			buf[w] = code;

			w ++;
			i += 3;
		}
		else	{
			buf[w] = c;
			i ++;
			w ++;
		}
	}

	return w;
}

/* eof */
